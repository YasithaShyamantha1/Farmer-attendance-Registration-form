<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Entries Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
      .container { max-width: 1100px; }
      table th, table td { vertical-align: middle; }
      .nowrap { white-space: nowrap; }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Saved Entries</h2>
        <div>
          <a class="btn btn-outline-primary me-2" id="refresh-btn"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
          <a class="btn btn-primary" id="export-btn" href="/export.csv"><i class="bi bi-download"></i> Export CSV</a>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped mb-0" id="entries-table">
              <thead class="table-light">
                <tr>
                  <th class="nowrap">ID</th>
                  <th>Role</th>
                  <th>Name</th>
                  <th>NIC</th>
                  <th>Address</th>
                  <th>Phone</th>
                  <th>Designation</th>
                  <th>Institution</th>
                  <th class="nowrap">Scanned Data</th>
                  <th class="nowrap">Created</th>
                </tr>
              </thead>
              <tbody id="entries-body">
                <tr><td colspan="10" class="text-center py-4">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function loadEntries(){
        const t = document.getElementById('entries-body');
        t.innerHTML = '<tr><td colspan="10" class="text-center py-4">Loading…</td></tr>';
        try{
          const res = await fetch('/entries');
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Invalid response');
          if (data.length === 0) {
            t.innerHTML = '<tr><td colspan="10" class="text-center py-4">No entries yet</td></tr>';
            return;
          }
          t.innerHTML = data.map(r => `
            <tr>
              <td class="nowrap">${r.id}</td>
              <td>${escapeHtml(r.role)}</td>
              <td>${escapeHtml(r.name || '')}</td>
              <td>${escapeHtml(r.nic || '')}</td>
              <td>${escapeHtml(r.address || '')}</td>
              <td>${escapeHtml(r.phone || '')}</td>
              <td>${escapeHtml(r.designation || '')}</td>
              <td>${escapeHtml(r.institution || '')}</td>
              <td class="text-truncate" style="max-width:200px">${escapeHtml(r.scanned_data || '')}</td>
              <td class="nowrap">${r.created_at}</td>
            </tr>`).join('\n');
        }catch(err){
          t.innerHTML = '<tr><td colspan="10" class="text-center text-danger py-4">Error loading entries</td></tr>';
          console.error(err);
        }
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]);
      }

      document.getElementById('refresh-btn').addEventListener('click', loadEntries);
      // initial load
      loadEntries();
    </script>
  </body>
</html>
